<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Site Selection – Nashville & Charlotte (Static Demo)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  header {
    background:#006d68; color:#fff; padding:12px 18px;
    font-weight:700; font-size:22px;
    box-shadow:0 2px 6px rgba(0,0,0,.2);
  }
  #map { position:absolute; top:64px; bottom:0; left:360px; right:0; }
  .panel {
    position:absolute; top:76px; left:12px; width:330px;
    background:#fff; padding:14px; border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.12); z-index:1000;
  }
  .panel h3 { margin:0 0 12px; }
  .row { margin-bottom:10px; }
  ol#top-list { padding-left:18px; }
  .kpi { font-size:13px; line-height:1.35; }
  .kpi strong { display:inline-block; width:190px; }
  .disabled-note {
    padding:6px 10px; margin-top:10px;
    font-size:13px; color:#444; background:#f3f3f3;
    border-radius:6px; border:1px solid #ccc;
  }

  /* blocks polygons */
  .blocks-poly {
    stroke:#004b87;
    stroke-width:1.1;
    fill-opacity:0.35;
  }

  /* existing-facility marker style */
  .existing-pin {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 26px;
    height: 26px;
    padding: 0 6px;
    border-radius: 999px;
    color: #fff;
    font-weight: 700;
    font-size: 11px;
    border: 2px solid #ffffff;
    box-shadow: 0 0 4px rgba(0,0,0,0.35);
  }
  .existing-pin::after {
    content: "";
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 6px 5px 0 5px;
    border-color: rgba(0,0,0,0.25) transparent transparent transparent;
    opacity: 0.6;
  }
</style>
</head>

<body>
<header>Harris Teeter & Gyms – Nashville & Charlotte (Static Demo)</header>

<div class="panel">

  <!-- FACILITY DROPDOWN -->
  <div class="row">
    <label for="facility"><strong>Choose facility</strong></label><br/>
    <select id="facility">
      <option value="nash_bjj">Nashville – BJJ</option>
      <option value="nash_cf">Nashville – CrossFit</option>
      <option value="charlotte_ht">Charlotte – Harris Teeter</option>
    </select>
  </div>

  <h3>Heatmap</h3>

  <!-- STATIC MODE NOTE -->
  <div class="disabled-note">
    Parameters disabled – using precomputed results.
  </div>

  <hr/>
  <div><strong>Top-10 Results</strong></div>
  <ol id="top-list"></ol>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ---------------- MAP SETUP ---------------- */
const facilityCenters = {
  "nash_bjj": [36.1627, -86.7816],    // Nashville
  "nash_cf": [36.1627, -86.7816],     // Nashville
  "charlotte_ht": [35.2271, -80.8431] // Charlotte uptown
};

const map = L.map("map", {
  zoomControl: true
}).setView(facilityCenters["nash_bjj"], 11);

// ---- PANES TO CONTROL Z-ORDER ----
map.createPane("paneHeat");
map.getPane("paneHeat").style.zIndex = 350;     // heat lower (canvas)

map.createPane("paneBlocks");
map.getPane("paneBlocks").style.zIndex = 450;   // polygons above heat

map.createPane("paneCompetitors");
map.getPane("paneCompetitors").style.zIndex = 600; // competitor dots

map.createPane("paneMarkers");
map.getPane("paneMarkers").style.zIndex = 650;  // existing brand facilities

map.createPane("paneTop10");
map.getPane("paneTop10").style.zIndex = 700;    // recommended top-10

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19}).addTo(map);

let heatLayer=null, htLayer=null, compLayer=null, topLayer=null, blocksLayer=null;
let layersControl = L.control.layers(null, null, {collapsed:false}).addTo(map);

const fmt0 = n => Number.isFinite(n) ? n.toFixed(0) : "0";
const fmt2 = n => Number.isFinite(n) ? n.toFixed(2) : "0.00";
const money = n => Number.isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:0}) : "0";

/* ---------------- HELPERS ---------------- */
function clearOverlays() {
  const overlays = [heatLayer, htLayer, compLayer, topLayer, blocksLayer];
  overlays.forEach(l => {
    if (l) {
      map.removeLayer(l);
      try { layersControl.removeLayer(l); } catch(_) {}
    }
  });
  heatLayer = htLayer = compLayer = topLayer = blocksLayer = null;
}

/* ---------------- COLOR SCALE FOR BLOCK DENSITY ---------------- */
function densityColor(d) {
  if (d >= 8000) return "#084081";
  if (d >= 6000) return "#0868ac";
  if (d >= 4000) return "#2b8cbe";
  if (d >= 2000) return "#4eb3d3";
  if (d >= 1000) return "#7bccc4";
  if (d >= 500)  return "#a8ddb5";
  if (d > 0)     return "#ccebc5";
  return "#f7f7f7";
}

/* ---------------- BLOCKS LAYER (STATIC GEOJSON) ---------------- */
const blockFiles = {
  "nash_bjj": "/static/blocks_nashville.json",
  "nash_cf": "/static/blocks_nashville.json",
  "charlotte_ht": "/static/blocks_charlotte.json"
};

async function loadBlocksForFacility(facility) {
  const url = blockFiles[facility];
  if (!url) return;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (blocksLayer) {
      map.removeLayer(blocksLayer);
      try { layersControl.removeLayer(blocksLayer); } catch(_) {}
    }

    blocksLayer = L.geoJSON(data, {
      pane: "paneBlocks",
      style: function(feature) {
        const props = feature.properties || {};
        const dens = Number(props.pop_per_sqmi || 0);
        return {
          color: "#004b87",
          weight: 1.1,
          fillColor: densityColor(dens),
          fillOpacity: 0.35,
          className: "blocks-poly"
        };
      },
      onEachFeature: function(feature, layer) {
        const p = feature.properties || {};
        const pop   = Number(p.population || 0);
        const dens  = Number(p.pop_per_sqmi || 0);
        const inc   = Number(p.median_income || 0);
        const area  = Number(p.area_sqmi || 0);

        const html = `
          <b>Block group</b><br/>
          Population: ${pop.toLocaleString()}<br/>
          Pop / sq mi: ${dens.toFixed(0)}<br/>
          Median income: $${inc.toLocaleString()}<br/>
          Area: ${area.toFixed(2)} sq mi
        `;

        // Popup on click
        layer.bindPopup(html);

        // Tooltip on hover
        layer.bindTooltip(html, {
          sticky: true,
          direction: "top",
          opacity: 0.9
        });
      }
    }).addTo(map);

    layersControl.addOverlay(blocksLayer, "Block groups (granular)");
  } catch (err) {
    console.error("Error loading blocks layer", err);
  }
}

/* ---------- helper: existing-facility icon ---------- */
function existingLabelForFacility(facility) {
  if (facility === "nash_bjj") return "BJJ";
  if (facility === "nash_cf")  return "CF";
  if (facility === "charlotte_ht") return "HT";
  return "";
}

function createExistingIcon(label) {
  return L.divIcon({
    className: "",
    html: `<div class="existing-pin" style="background:#2e7d32;">${label}</div>`,
    iconSize: [32, 32],
    iconAnchor: [16, 30],
    popupAnchor: [0, -30]
  });
}

/* ---------------- DRAW MAP LAYERS ---------------- */
function draw(payload, facility){
  // clear EVERYTHING including blocks;
  const oldBlocks = blocksLayer;
  blocksLayer = null;
  clearOverlays();
  blocksLayer = oldBlocks;  // keep reference so loadBlocksForFacility can remove if needed

  /* HEATMAP */
  if (payload.heat_points && payload.heat_points.length){
    heatLayer = L.heatLayer(payload.heat_points,{
      pane: "paneHeat",
      radius:18, blur:16, maxZoom:14
    }).addTo(map);
    layersControl.addOverlay(heatLayer, "Heatmap");
  }

  /* EXISTING BRAND FACILITIES (green pill markers with label) */
  if (payload.ht_scored && payload.ht_scored.length){
    const label = existingLabelForFacility(facility);
    htLayer = L.layerGroup(
      payload.ht_scored.map(ht => {
        const popup = `
          <b>Existing facility</b><br/>
          Score: ${fmt2(ht.score)}<br/>
          Stores per 10k: ${fmt2(ht.stores_per_10k)}<br/>
          Median income: $${money(ht.income_med)}<br/>
          Dijkstra access: ${fmt2(ht.access_score_dj)}
        `;

        const marker = L.marker([ht.lat, ht.lon], {
          pane: "paneMarkers",
          icon: createExistingIcon(label)
        }).bindPopup(popup);

        marker.on("mouseover", e => e.target.openPopup());

        return marker;
      })
    ).addTo(map);
    layersControl.addOverlay(htLayer, "Existing facilities (scored)");
  }

  /* COMPETITORS */
  if (payload.competitors && payload.competitors.length){
    compLayer = L.layerGroup(payload.competitors.map(
      ([lat,lon]) => L.circleMarker([lat,lon],{
        pane: "paneCompetitors",
        radius:3,
        color:"#F4511E",
        weight:1
      }).bindTooltip("Competitor", {permanent:false, direction:"top"})
    )).addTo(map);
    layersControl.addOverlay(compLayer, "Competitors");
  }

  /* TOP-10 NEW SITES (blue pins) */
  const ol = document.getElementById("top-list");
  ol.innerHTML = "";
  if (payload.top10 && payload.top10.length){
    topLayer = L.layerGroup();
    payload.top10.forEach((p,i)=>{
      const m = L.marker([p.lat,p.lon], { pane: "paneTop10" }).bindPopup(
        `<b>#${i+1} – New site</b><br/>
         Score: ${fmt2(p.score)}<br/>
         Stores per 10k: ${fmt2(p.stores_per_10k)}<br/>
         Median income: $${money(p.income_med)}<br/>
         Dijkstra access: ${fmt2(p.access_score_dj)}`
      );
      topLayer.addLayer(m);

      const li = document.createElement("li");
      li.innerHTML = `#${i+1} • score=${fmt2(p.score)}<br/>
        <span class="kpi">
          <strong>Stores per 10k:</strong> ${fmt2(p.stores_per_10k)}<br/>
          <strong>Median income:</strong> $${money(p.income_med)}<br/>
          <strong>Dijkstra access:</strong> ${fmt2(p.access_score_dj)}
        </span>`;
      li.style.marginBottom = "10px";
      li.addEventListener("mouseenter",()=>m.openPopup());
      ol.appendChild(li);
    });

    topLayer.addTo(map);
    layersControl.addOverlay(topLayer, "Top-10 new sites");
  }
}

/* ---------------- FETCH STATIC JSON ---------------- */
async function loadStaticResult(){
  const facility = document.getElementById("facility").value;
  const url = `/recompute?facility=${facility}`;

  const res = await fetch(url);
  const payload = await res.json();
  if (!payload.ok){
    alert(payload.error || "Error loading static data");
    return;
  }

  draw(payload, facility);

  // load corresponding blocks layer (granular population)
  loadBlocksForFacility(facility);
}

/* ---------------- EVENT HANDLERS ---------------- */
document.getElementById("facility").addEventListener("change", () => {
  const f = document.getElementById("facility").value;
  map.setView(facilityCenters[f], 11);
  loadStaticResult();
});

/* ---------------- INITIAL LOAD ---------------- */
loadStaticResult();

</script>
</body>
</html>
